pipeline {
    agent any

    stages {
        stage('Install dependencies') {
            steps {
                // Clone repo and install dependencies
                git credentialsId: 'GIT_EPAM_PAT', 
                    url: 'https://git.epam.com/anton_rak/set_basic_api_js.git', 
                    branch: 'master'
                
                sh 'npm install'
                
                // Start API server in background
                sh 'npm run start_server &'
            }
        }

        stage('Lint') {
            steps {
                sh 'npm run lint'
            }
        }

        // stage('Unit tests with coverage') {
        //     steps {
        //         sh 'npm run unit_tests_coverage'
        //     }
        // }

        // stage('Unit tests') {
        //     steps {
        //         sh 'npm run unit_tests'
        //     }
        // }
        

        stage('API tests') {
            steps {
                sh 'npm install'
                sh 'npm run start_server'
                sh 'npm run api_tests'
            }
        }
    }

    post {
        success {
            echo "All quality gates passed."
            githubNotify context: 'Testing Pipeline', status: 'SUCCESS'
        }
        failure {
            echo "Quality gate failed."
            githubNotify context: 'Testing Pipeline', status: 'FAILURE'
        }
    }
}
