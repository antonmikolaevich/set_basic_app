properties([
    pipelineTriggers([
        pollSCM('H/1 * * * *')   // Polls SCM every 1 minute
    ])
])

node {

    stage('Checkout & Install') {
        git credentialsId: 'GITHUB_PAT',
            url: 'https://github.com/antonmikolaevich/set_basic_app.git',
            branch: 'master'

        sh 'npm install'
    }

    stage('Lint') {
        sh 'npm run lint'
    }

    stage('Unit Tests Coverage') {
        withCredentials([string(credentialsId: 'MONGO_URI', variable: 'MONGO_URI')]) {
            sh '''
                echo "Setting up roles..."
                MONGO_URI="$MONGO_URI" npm run set_roles

                echo "Setting up booking statuses..."
                MONGO_URI="$MONGO_URI" npm run set_booking_statuses

                echo "Starting API server for Unit Tests Coverage..."
                MONGO_URI="$MONGO_URI" npm run start_server &
                SERVER_PID=$!
                echo "Started server with PID: $SERVER_PID"

                sleep 15
                echo "Running Unit Tests Coverage..."
                npm run unit_tests_coverage

                echo "Stopping API server..."
                kill $SERVER_PID || true
            '''
        }
    }

    stage('Unit Tests') {
        withCredentials([string(credentialsId: 'MONGO_URI', variable: 'MONGO_URI')]) {
            sh '''
                echo "Setting up roles..."
                MONGO_URI="$MONGO_URI" npm run set_roles

                echo "Setting up booking statuses..."
                MONGO_URI="$MONGO_URI" npm run set_booking_statuses

                echo "Starting API server for Unit Tests..."
                MONGO_URI="$MONGO_URI" npm run start_server &
                SERVER_PID=$!
                echo "Started server with PID: $SERVER_PID"

                sleep 15
                echo "Running Unit Tests..."
                npm run unit_tests

                echo "Stopping API server..."
                kill $SERVER_PID || true
            '''
        }
    }
}