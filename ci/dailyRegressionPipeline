pipeline {
    agent any

    options {
        // Ensures only one branch/job runs at a time for this repo
        lock(resource: 'set_basic_app-global-lock')
    }

    stages {

        stage('Checkout & Install') {
            steps {
                git credentialsId: 'GITHUB_PAT',
                    url: 'https://github.com/antonmikolaevich/set_basic_app.git',
                    branch: 'master'

                sh 'npm install'
            }
        }

        stage('UI Tests') {
            steps {
                withCredentials([string(credentialsId: 'MONGO_URI', variable: 'MONGO_URI')]) {
                    sh '''
                        # Show current workspace structure
                        echo "Current directory: $(pwd)"
                        echo "Files and folders in workspace:"
                        ls -R

                        # Setup MongoDB roles and statuses
                        echo "Setting up roles..."
                        MONGO_URI="$MONGO_URI" npm run set_roles

                        echo "Setting up booking statuses..."
                        MONGO_URI="$MONGO_URI" npm run set_booking_statuses

                        # Start API server
                        echo "Starting API server..."
                        MONGO_URI="$MONGO_URI" npm run start_server &
                        API_PID=$!
                        echo $API_PID > api_server_pid.txt

                        sleep 10
                        echo "After sleep 10, current directory: $(pwd)"

                        # Start UI app
                        echo "Switching to UI folder..."
                        cd ui_part
                        echo "Now in directory: $(pwd)"
                        echo "Installing UI dependencies..."
                        npm install

                        echo "Starting UI app in background..."
                        nohup node app.js > ../ui.log 2>&1 &
                        UI_PID=$!
                        echo $UI_PID > ../ui_pid.txt

                        sleep 5

                        # Run UI tests
                        echo "Switching to UI tests folder..."
                        cd ../ui_testing
                        echo "Now in directory: $(pwd)"
                        echo "Installing UI test dependencies..."
                        npm install

                        echo "Running UI tests..."
                        npm test

                        cd ..
                    '''
                }
            }
        }
    }

    post {
        always {
            // Archive the UI test HTML report
            archiveArtifacts artifacts: 'ui_testing/playwright-report/index.html', allowEmptyArchive: true
        }

        success {
            echo "UI tests completed successfully."
        }

        failure {
            echo "UI tests failed."
        }
    }
}
